# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**ClipMark** ("Mark the moments that matter") is a single-page React application for saving, organizing, and annotating YouTube videos. Users can bookmark videos, create notes at specific timestamps, organize bookmarks into categories, and optionally fetch video metadata and AI-generated summaries.

**Brand Colors:**
- Primary: Emerald (#10b981)
- Primary Light: Teal (#34d399)
- Accent: Gold/Yellow (#fbbf24)
- Dark BG: Slate (#0f172a)

**Key Features:**
- Bookmark YouTube videos with metadata
- Add timestamped notes during video playback
- Organize videos into custom categories
- Tag videos with keywords
- Optional AI summaries via Gemini API
- **AI Note Enhancement**: Batch-process notes using Gemini to expand with transcript context and format as bullet points
- **Markdown Export**: Download notes as formatted .md files
- YouTube API integration for metadata
- Data persistence via localStorage and optional server backend
- **User Profiles**: Edit profile with first name, last name, email, and interests
- **Video Sharing**: Share videos with other ClipMark users or via email invitation
- **Shared Library**: View videos shared with you in a dedicated "Shared with me" tab
- **Library View Modes**: Toggle between grid and list views in the library
- **Video View Count**: Track how many times each video has been opened

## Architecture

The app is a **single HTML file** (`app.html`) with React components embedded using JSX compiled by Babel. There is no build process—it runs directly in the browser. A separate landing page (`index.html`) provides marketing content.

### Data Flow

1. **State Management**: React hooks (useState, useEffect) manage all app state
   - `videos`: Array of bookmarked videos with nested notes
   - `categories`: User-created organization categories
   - `activeVideoId`: Currently playing video
   - `geminiApiKey`, `youtubeApiKey`: API credentials stored in localStorage
   - `isEnhancing`, `enhancementProgress`: Track AI enhancement processing state
   - `pendingEnhancements`, `showEnhancementReview`: Handle ambiguous AI results

2. **Persistence Layers** (in priority order):
   - **Server**: Optional backend at `SERVER_URL` (defaults to `http://localhost:3000`)
   - **localStorage**: Fallback and backup for videos, categories, and API keys
   - Both are attempted; localStorage is always used for API keys (device-specific)

3. **Key Data Structures**:
   ```javascript
   Video: {
     id, videoId, title, category, tags, notes: [Note],
     publishDate, thumbnail, description, viewCount
   }

   Note: {
     id, text, timestamp, createdAt, autoGenerated, aiGenerated
   }

   Category: { id, name, color }

   // User profile (stored in data/users.json)
   User: {
     userId, username, passwordHash, createdAt, suspended,
     profile: { firstName, lastName, email, interests: [], updatedAt }
   }

   // Share record (stored in data/shares.json)
   Share: {
     id, type: 'user'|'email', ownerId, ownerUsername,
     videoId, youtubeVideoId, videoTitle, videoThumbnail,
     includeNotes, notes: [Note]|null,
     targetUserId|null, targetEmail|null,
     status: 'pending'|'accepted'|'declined'|'expired',
     shareToken|null, tokenExpiresAt|null,
     createdAt, acceptedAt|null
   }
   ```

### Component Hierarchy

- **App** (main container)
  - YouTubePlayer (embedded iframe)
  - VideoCard (grid view thumbnail with view count and notes count)
  - VideoListItem (list view row with metadata)
  - NoteItem (timestamped note with bullet point rendering)
  - AddVideoModal / EditVideoModal
  - CategoryModal
  - SettingsModal (with link to ProfileModal)
  - ProfileModal (edit user profile: name, email, interests)
  - ShareModal (share video with user or via email)
  - PendingSharesDropdown (notification bell for incoming shares)
  - EnhancementReviewModal (for reviewing ambiguous AI suggestions)

### Data Loading on Refresh

When the app loads:
1. Loads categories from localStorage
2. Attempts to fetch bookmarks from server; falls back to localStorage
3. Loads API keys from localStorage (device-local only)
4. Any changes are debounced and saved to both localStorage and server

**Important**: Notes are stored as nested arrays within video objects, not separately. When a video is deleted, all its notes are deleted.

## Backend (Optional)

- **transcript-server.js**: Node.js server that fetches YouTube transcripts
  - Runs on port 3456
  - Accessible via `/transcript?v={videoId}` endpoint
  - Returns parsed transcript segments with timestamps

### Sharing API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/profile` | Get current user's profile |
| PUT | `/api/profile` | Update profile fields |
| GET | `/api/users/search?q={query}` | Search users by username |
| POST | `/api/shares` | Create share (rate limited: 10/hour) |
| GET | `/api/shares/outgoing` | Shares created by user |
| GET | `/api/shares/incoming` | Pending shares for user |
| GET | `/api/shares/library` | Accepted shares (shared-with-me) |
| POST | `/api/shares/{id}/accept` | Accept pending share |
| POST | `/api/shares/{id}/decline` | Decline pending share |
| DELETE | `/api/shares/{id}` | Revoke share (owner only) |
| GET | `/api/shares/preview?token={token}` | Public - get email share preview |
| POST | `/api/shares/claim?token={token}` | Claim email share after signup |

- Expected backend at `http://localhost:3000` for bookmark sync (not included in repo)

## Common Development Commands

```bash
# Install dependencies (for transcript server only)
npm install

# Run transcript server (in background)
node transcript-server.js

# Run HTTP server for the app (using Python, for example)
python3 -m http.server 8000
# Then visit http://localhost:8000
```

## Key Implementation Details

### localStorage Keys
- `ytBookmarks_videos`: Video bookmarks with notes
- `ytBookmarks_categories`: User categories
- `ytBookmarks_geminiApiKey`: Device-local Gemini API key
- `ytBookmarks_youtubeApiKey`: Device-local YouTube API key

### Note Generation
The app supports three note types:
- **Manual**: User-typed notes
- **Auto-generated**: Extracted from transcript at specific timestamps
- **AI-generated**: Summaries created by Gemini API

### AI Note Enhancement
The "Enhance Notes" feature in the toolbar below the video player batch-processes all notes for the active video:
1. Fetches the video transcript (requires transcript server)
2. For each note, extracts 75 words before/after the timestamp (`getExtendedTranscriptContext`)
3. Calls Gemini API to summarize the note with context (`summarizeNoteWithContext`)
4. Returns bullet-point formatted summaries
5. Ambiguous notes (where AI is uncertain) show a review modal with radio button options
6. User can select from alternatives, keep original, or enter custom text

### Markdown Export
The "Download .md" button exports notes as a formatted Markdown file including:
- Video title and publish date
- YouTube link
- Notes organized by timestamp with bullet point formatting
- Export watermark with date

### API Integration
- **Gemini API**: Optional, for video summary generation
- **YouTube API**: Optional, for fetching video metadata (publish date, description, thumbnail)
- **noembed.com**: Fallback for upload date when YouTube API key unavailable

### Debounced Saving
Videos save with debouncing (500ms) to avoid excessive server requests when multiple notes are added/edited rapidly.

## Debugging Notes

- The app logs extensively to console (prefixed with ✅, ⚠️, ❌ for filtering)
- All localStorage accesses are wrapped in try-catch blocks
- Server failures gracefully degrade to localStorage-only mode
- The YouTube player API is loaded asynchronously; player initialization includes cleanup to prevent duplicate listeners

## Known Issues & Edge Cases

1. **iPad Refresh Deletion**: When refreshing, localStorage might be cleared if the app is in incognito/private mode or if the browser's cache is cleared. Ensure data is synced to server for persistence.
2. **CORS**: The app uses CORS for server communication; ensure backend has proper CORS headers.
3. **YouTube API Quotas**: Video metadata fetching uses YouTube API quota; batching or caching recommended for many videos.
4. **Transcript Server**: Requires external access to YouTube; may fail in restricted networks.

## Documentation Requirements

**IMPORTANT**: After completing any feature, bug fix, or significant change, automatically:

1. **Update CHANGELOG.md** with:
   - Date and brief description of changes
   - Files modified
   - Any new environment variables or dependencies added

2. **Update this CLAUDE.md** if:
   - New features are added (add to Key Features list)
   - Architecture changes (update Architecture section)
   - New environment variables or API integrations added
   - New known issues discovered

3. **Commit messages** should be descriptive and follow the format:
   ```
   Short summary of change

   - Bullet points with details
   - Files affected
   - Any breaking changes noted

   Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
   ```

Do NOT ask before documenting - just do it automatically as part of completing the work.

