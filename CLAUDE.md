# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**ClipMark** ("Mark the moments that matter") is a single-page React application for saving, organizing, and annotating videos from multiple platforms. Users can bookmark videos from YouTube, Vimeo, Loom, Wistia, Google Drive, or direct URLs (.mp4, .webm), create notes at specific timestamps, organize bookmarks into categories, and optionally fetch video metadata and AI-generated summaries.

**Brand Colors:**
- Primary: Emerald (#10b981)
- Primary Light: Teal (#34d399)
- Accent: Gold/Yellow (#fbbf24)
- Dark BG: Slate (#0f172a)

**Key Features:**
- **Multi-Source Video Support**: Bookmark videos from YouTube, Vimeo, Loom, Wistia, Google Drive, or direct URLs (.mp4, .webm)
- Add timestamped notes during video playback
- Organize videos into custom categories
- Tag videos with keywords
- Optional AI summaries via Gemini API
- **AI Note Enhancement**: Batch-process notes using Gemini to expand with transcript context and format as bullet points
- **Markdown Export**: Download notes as formatted .md files
- **Transcript Upload**: Upload SRT/VTT subtitle files for non-YouTube videos
- **AI Transcription**: Generate transcripts via Gemini for videos without transcripts (rate limited)
- YouTube API integration for metadata, oEmbed for Vimeo/Wistia
- Data persistence via localStorage and optional server backend
- **User Profiles**: Edit profile with first name, last name, email, and interests
- **Video Sharing**: Share videos with other ClipMark users or via email invitation
- **Shared Library**: View videos shared with you in a dedicated "Shared with me" tab
- **Library View Modes**: Toggle between grid and list views in the library
- **Video View Count**: Track how many times each video has been opened

## Architecture

The app is a **single HTML file** (`app.html`) with React components embedded using JSX compiled by Babel. There is no build process—it runs directly in the browser. A separate landing page (`index.html`) provides marketing content with feature descriptions and CTAs linking to `/app`. It also handles share token redirects (`?share_token=...` → `/app?share_token=...`).

### Data Flow

1. **State Management**: React hooks (useState, useEffect) manage all app state
   - `videos`: Array of bookmarked videos with nested notes
   - `categories`: User-created organization categories
   - `activeVideoId`: Currently playing video
   - `geminiApiKey`, `youtubeApiKey`: API credentials stored in localStorage
   - `isEnhancing`, `enhancementProgress`: Track AI enhancement processing state
   - `pendingEnhancements`, `showEnhancementReview`: Handle ambiguous AI results

2. **Persistence Layers** (in priority order):
   - **Server**: Backend at `transcript-server.js` (port 3456, or same origin when behind nginx)
   - **localStorage**: Fallback and backup for videos, categories, and API keys
   - Both are attempted; localStorage is always used for API keys (device-specific)
   - Server URL is auto-detected: same origin on port 80, otherwise `http://{hostname}:3456`

3. **Key Data Structures**:
   ```javascript
   Video: {
     id, title, category, tags, notes: [Note],
     publishDate, thumbnail, description, viewCount,
     // Multi-source fields
     sourceType,         // 'youtube' | 'vimeo' | 'loom' | 'wistia' | 'direct'
     sourceId,           // Platform-specific video ID
     sourceUrl,          // Original URL (needed for direct videos)
     videoId,            // Deprecated, kept for backward compatibility (YouTube only)
     transcript: {       // Stored transcript for non-YouTube videos
       segments: [],     // [{start, duration, text}]
       source            // 'platform' | 'srt' | 'vtt' | 'ai'
     }
   }

   Note: {
     id, text, timestamp, createdAt, autoGenerated, aiGenerated
   }

   Category: { id, name, color }

   // User profile (stored in data/users.json)
   User: {
     userId, username, passwordHash, createdAt, suspended,
     profile: { firstName, lastName, email, interests: [], updatedAt }
   }

   // Share record (stored in data/shares.json)
   Share: {
     id, type: 'user'|'email', ownerId, ownerUsername,
     videoId, youtubeVideoId, videoTitle, videoThumbnail,
     includeNotes, notes: [Note]|null,
     targetUserId|null, targetEmail|null,
     status: 'pending'|'accepted'|'declined'|'expired',
     shareToken|null, tokenExpiresAt|null,
     createdAt, acceptedAt|null
   }
   ```

### Component Hierarchy

- **App** (main container)
  - **VideoPlayer** (unified player wrapper - switches between adapters based on sourceType)
    - YouTubePlayer (YouTube IFrame API)
    - VimeoPlayerAdapter (Vimeo Player SDK)
    - WistiaPlayerAdapter (Wistia JS API)
    - LoomPlayerAdapter (iframe embed, limited controls)
    - GoogleDrivePlayerAdapter (iframe embed, limited controls)
    - HTML5PlayerAdapter (native `<video>` for direct URLs)
  - VideoCard (grid view thumbnail with view count and notes count)
  - VideoListItem (list view row with metadata)
  - VideoSourceBadge (shows platform icon for non-YouTube videos)
  - NoteItem (timestamped note with bullet point rendering)
  - AddVideoModal / EditVideoModal
  - CategoryModal
  - SettingsModal (with link to ProfileModal)
  - ProfileModal (edit user profile: name, email, interests)
  - ShareModal (share video with user or via email)
  - PendingSharesDropdown (notification bell for incoming shares)
  - EnhancementReviewModal (for reviewing ambiguous AI suggestions)
  - TranscriptUploadModal (upload SRT/VTT files for non-YouTube videos)
  - TranscriptStatusBadge (shows transcript source: platform/srt/vtt/ai)

### Data Loading on Refresh

When the app loads:
1. Loads categories from localStorage
2. Attempts to fetch bookmarks from server; falls back to localStorage
3. Loads API keys from localStorage (device-local only)
4. Any changes are debounced and saved to both localStorage and server

**Important**: Notes are stored as nested arrays within video objects, not separately. When a video is deleted, all its notes are deleted.

## Backend

**`transcript-server.js`** is the unified Node.js backend handling all server functionality: authentication, bookmarks, transcripts, sharing, and API proxying. It runs on port 3456 (configurable via `PORT` env var).

**Data storage**: JSON files in `data/` directory:
- `data/users.json` — User accounts, profiles, and watch time
- `data/sessions.json` — Active session tokens
- `data/shares.json` — Share records

### Authentication

- **Bearer token auth**: UUID tokens stored in `data/sessions.json`, 30-day expiry
- **Password hashing**: bcryptjs with 10 salt rounds
- **Rate limiting**: 5 failed login attempts = 15-minute lockout per IP/username
- **Account suspension**: Users can be marked `suspended: true` in users.json
- **Frontend storage**: Token stored in localStorage as `ytBookmarks_authToken`
- **Session restore**: On app load, calls `/auth/check` to validate stored token

### Auth Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/auth/register` | Create account (validates username 3-30 chars, password 6+) |
| POST | `/auth/login` | Login (rate limited) |
| POST | `/auth/logout` | Logout (deletes session) |
| GET | `/auth/check` | Verify token validity, returns user profile if valid |

### Sharing API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/profile` | Get current user's profile |
| PUT | `/api/profile` | Update profile fields |
| GET | `/api/users/search?q={query}` | Search users by username |
| POST | `/api/shares` | Create share (rate limited: 10/hour) |
| GET | `/api/shares/outgoing` | Shares created by user |
| GET | `/api/shares/incoming` | Pending shares for user |
| GET | `/api/shares/library` | Accepted shares (shared-with-me) |
| POST | `/api/shares/{id}/accept` | Accept pending share |
| POST | `/api/shares/{id}/decline` | Decline pending share |
| DELETE | `/api/shares/{id}` | Revoke share (owner only) |
| GET | `/api/shares/preview?token={token}` | Public - get email share preview |
| POST | `/api/shares/claim?token={token}` | Claim email share after signup |

### Transcript Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/transcript?v={videoId}` | Fetch YouTube transcript (no auth) |
| POST | `/api/transcript/upload` | Parse uploaded SRT/VTT file to segments |
| POST | `/api/transcript/generate` | AI transcription via Gemini (rate limited: 5/hour) |

### Other Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET/POST/PUT | `/bookmarks` | Sync video bookmarks (auth required) |
| GET/POST/PUT | `/categories` | Sync categories (auth required) |
| GET | `/api/youtube/video` | Proxy YouTube metadata fetch |
| POST | `/api/gemini` | Proxy Gemini AI requests |
| POST | `/api/admin/watch-time` | Track video watch time |
| GET | `/api/status` | Server health check |
| GET | `/` | Serves `index.html` (landing page) |
| GET | `/app` | Serves `app.html` (main app) |

## Common Development Commands

```bash
# Install dependencies
npm install

# Run the server (handles everything: app serving, auth, transcripts, sharing)
node transcript-server.js
# Then visit http://localhost:3456

# Or for local dev without backend, serve static files directly:
python3 -m http.server 8000
# Then visit http://localhost:8000 (no auth/sharing/transcript features)
```

**Note**: There are no automated tests. Testing is manual. A transcript testing UI is available at `/test` when the server is running.

## Key Implementation Details

### localStorage Keys
- `ytBookmarks_videos`: Video bookmarks with notes
- `ytBookmarks_categories`: User categories
- `ytBookmarks_geminiApiKey`: Device-local Gemini API key
- `ytBookmarks_youtubeApiKey`: Device-local YouTube API key
- `ytBookmarks_authToken`: Session bearer token for server auth

### Note Generation
The app supports three note types:
- **Manual**: User-typed notes
- **Auto-generated**: Extracted from transcript at specific timestamps
- **AI-generated**: Summaries created by Gemini API

### AI Note Enhancement
The "Enhance Notes" feature in the toolbar below the video player batch-processes all notes for the active video:
1. Fetches the video transcript (requires transcript server)
2. For each note, extracts 75 words before/after the timestamp (`getExtendedTranscriptContext`)
3. Calls Gemini API to summarize the note with context (`summarizeNoteWithContext`)
4. Returns bullet-point formatted summaries
5. Ambiguous notes (where AI is uncertain) show a review modal with radio button options
6. User can select from alternatives, keep original, or enter custom text

### Markdown Export
The "Download .md" button exports notes as a formatted Markdown file including:
- Video title and publish date
- Source-aware video link (YouTube, Vimeo, Loom, Wistia, or direct URL)
- Notes organized by timestamp with bullet point formatting
- Export watermark with date

### API Integration
- **Gemini API**: Optional, for video summary generation
- **YouTube API**: Optional, for fetching video metadata (publish date, description, thumbnail)
- **noembed.com**: Fallback for upload date when YouTube API key unavailable

### Video View Count
The `viewCount` field on each video is incremented client-side via `incrementViewCount(videoId)` each time a video is selected for playback. It persists to both localStorage and the server (via `/bookmarks` sync). Displayed as an eye icon in grid view and "X views" text in list view. Separate from **watch time tracking**, which accumulates seconds watched and syncs to the server every 30 seconds via `POST /api/admin/watch-time`.

### Debounced Saving
Videos save with debouncing (500ms) to avoid excessive server requests when multiple notes are added/edited rapidly.

## Debugging Notes

- The app logs extensively to console (prefixed with ✅, ⚠️, ❌ for filtering)
- All localStorage accesses are wrapped in try-catch blocks
- Server failures gracefully degrade to localStorage-only mode
- The YouTube player API is loaded asynchronously; player initialization includes cleanup to prevent duplicate listeners

## Known Issues & Edge Cases

1. **iPad Refresh Deletion**: When refreshing, localStorage might be cleared if the app is in incognito/private mode or if the browser's cache is cleared. Ensure data is synced to server for persistence.
2. **CORS**: The app uses CORS for server communication; ensure backend has proper CORS headers.
3. **YouTube API Quotas**: Video metadata fetching uses YouTube API quota; batching or caching recommended for many videos.
4. **Transcript Server**: Requires external access to YouTube; may fail in restricted networks.
5. **Loom Player Limitations**: Loom's embed API does not support programmatic seeking or time retrieval. Timestamp notes are approximate.
6. **Google Drive Player Limitations**: Google Drive's embed does not support programmatic seeking or time retrieval. Timestamp notes are approximate.
7. **AI Transcription Rate Limit**: Limited to 5 AI transcription requests per hour to manage API costs.
8. **Direct Video Seeking**: Some servers may not support seeking without proper HTTP range request headers.
9. **Private Videos**: Vimeo/Wistia private videos require embed allowlisting to work in the player.

## Documentation Requirements

**IMPORTANT**: After completing any feature, bug fix, or significant change, automatically:

1. **Update CHANGELOG.md** with:
   - Date and brief description of changes
   - Files modified
   - Any new environment variables or dependencies added

2. **Update this CLAUDE.md** if:
   - New features are added (add to Key Features list)
   - Architecture changes (update Architecture section)
   - New environment variables or API integrations added
   - New known issues discovered

3. **Commit messages** should be descriptive and follow the format:
   ```
   Short summary of change

   - Bullet points with details
   - Files affected
   - Any breaking changes noted

   Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>
   ```

Do NOT ask before documenting - just do it automatically as part of completing the work.

